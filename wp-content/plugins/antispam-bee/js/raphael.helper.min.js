var tokenRegex=/\{([^\}]+)\}/g,objNotationRegex=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,replacer=function(b,d,f){var a=f;d.replace(objNotationRegex,function(b,c,e,d,f){c=c||d;a&&(c in a&&(a=a[c]),"function"==typeof a&&f&&(a=a()))});return a=(null==a||a==f?b:a)+""},fill=function(b,d){return String(b).replace(tokenRegex,function(b,a){return replacer(b,a,d)})};
Raphael.fn.drawGrid=function(b,d,f,a,k,c,e){e=e||"#000";c=["M",Math.round(b)+0.5,Math.round(d)+0.5,"L",Math.round(b+f)+0.5,Math.round(d)+0.5,Math.round(b+f)+0.5,Math.round(d+a)+0.5,Math.round(b)+0.5,Math.round(d+a)+0.5,Math.round(b)+0.5,Math.round(d)+0.5];f/=k;for(i=1;i<k;i++)c=c.concat(["M",Math.round(b+i*f)+0.5,Math.round(d)+0.5,"V",Math.round(d+a)+0.5]);return this.path(c.join(",")).attr({stroke:e})};
Raphael.fn.popup=function(b,d,f,a,k){a=String(a||"top-middle").split("-");a[1]=a[1]||"middle";var c=f.getBBox(),e=Math.round(c.width),h=Math.round(c.height),l=Math.round(c.x)-5,c=Math.round(c.y)-5,g=Math.min(h/2,e/2,10),p=[{x:l+5,y:c,w:e,w4:e/4,h4:h/4,right:0,left:e-2*g,bottom:0,top:h-2*g,r:5,h:h,gap:g},{x:l+5,y:c,w:e,w4:e/4,h4:h/4,left:e/2-g,right:e/2-g,top:h/2-g,bottom:h/2-g,r:5,h:h,gap:g},{x:l+5,y:c,w:e,w4:e/4,h4:h/4,left:0,right:e-2*g,top:0,bottom:h-2*g,r:5,h:h,gap:g}]["middle"==a[1]?1:2*("top"==
a[1]||"left"==a[1])],m=0,n=0,q=this.path(fill({top:"M{x},{y}h{w4},{w4},{w4},{w4}a{r},{r},0,0,1,{r},{r}v{h4},{h4},{h4},{h4}a{r},{r},0,0,1,-{r},{r}l-{right},0-{gap},{gap}-{gap}-{gap}-{left},0a{r},{r},0,0,1-{r}-{r}v-{h4}-{h4}-{h4}-{h4}a{r},{r},0,0,1,{r}-{r}z",bottom:"M{x},{y}l{left},0,{gap}-{gap},{gap},{gap},{right},0a{r},{r},0,0,1,{r},{r}v{h4},{h4},{h4},{h4}a{r},{r},0,0,1,-{r},{r}h-{w4}-{w4}-{w4}-{w4}a{r},{r},0,0,1-{r}-{r}v-{h4}-{h4}-{h4}-{h4}a{r},{r},0,0,1,{r}-{r}z",right:"M{x},{y}h{w4},{w4},{w4},{w4}a{r},{r},0,0,1,{r},{r}v{h4},{h4},{h4},{h4}a{r},{r},0,0,1,-{r},{r}h-{w4}-{w4}-{w4}-{w4}a{r},{r},0,0,1-{r}-{r}l0-{bottom}-{gap}-{gap},{gap}-{gap},0-{top}a{r},{r},0,0,1,{r}-{r}z",
left:"M{x},{y}h{w4},{w4},{w4},{w4}a{r},{r},0,0,1,{r},{r}l0,{top},{gap},{gap}-{gap},{gap},0,{bottom}a{r},{r},0,0,1,-{r},{r}h-{w4}-{w4}-{w4}-{w4}a{r},{r},0,0,1-{r}-{r}v-{h4}-{h4}-{h4}-{h4}a{r},{r},0,0,1,{r}-{r}z"}[a[0]],p)).insertBefore(f);switch(a[0]){case "top":m=b-(l+5+p.left+g);n=d-(c+5+h+5+g);break;case "bottom":m=b-(l+5+p.left+g);n=d-(c-g);break;case "left":m=b-(l+5+e+5+g);n=d-(c+5+p.top+g);break;case "right":m=b-(l-g),n=d-(c+5+p.top+g)}q.translate(m,n);if(k)return k=q.attr("path"),q.remove(),
{path:k,dx:m,dy:n};f.translate(m,n);return q};function getAnchors(b,d,f,a,k,c){var e=(f-b)/2,h=(k-f)/2;b=Math.atan((f-b)/Math.abs(a-d));k=Math.atan((k-f)/Math.abs(a-c));b=d<a?Math.PI-b:b;k=c<a?Math.PI-k:k;c=Math.PI/2-(b+k)%(2*Math.PI)/2;d=e*Math.sin(c+b);e*=Math.cos(c+b);b=h*Math.sin(c+k);h*=Math.cos(c+k);return{x1:f-d,y1:a+e,x2:f+b,y2:a+h}};